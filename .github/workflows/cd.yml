name: Continuous Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy"
        required: true
        default: "dev"
        type: choice
        options:
          - dev
      deploy_core:
        description: "Deploy core infrastructure"
        required: false
        default: true
        type: boolean
      deploy_services:
        description: "Deploy services"
        required: false
        default: true
        type: boolean

permissions:
  id-token: write
  contents: write
  pull-requests: write

concurrency:
  group: cd-${{ github.event.inputs.environment || 'dev' }}
  cancel-in-progress: false

jobs:
  deploy-core:
    name: "Deploy Core Infrastructure"
    if: ${{ github.event.inputs.deploy_core == 'true' }}
    uses: ./.github/workflows/deploy-core.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit

  deploy-ui:
    name: "Deploy UI Service"
    if: ${{ github.event.inputs.deploy_services == 'true' }}
    needs: [deploy-core]
    uses: ./.github/workflows/deploy-ui-service.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit

  deploy-api:
    name: "Deploy API Service"
    if: ${{ github.event.inputs.deploy_services == 'true' }}
    needs: [deploy-core]
    uses: ./.github/workflows/deploy-api-service.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit

  deploy-ai-chat:
    name: "Deploy AI Chat Service"
    if: ${{ github.event.inputs.deploy_services == 'true' }}
    needs: [deploy-core]
    uses: ./.github/workflows/deploy-ai-chat-service.yml
    with:
      environment: ${{ github.event.inputs.environment || 'dev' }}
    secrets: inherit
